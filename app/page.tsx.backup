'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import FileUpload from '../components/FileUpload';
import GoogleAuth from '../components/GoogleAuth';

interface Message {
  role: 'user' | 'assistant';
  content: string;
  timestamp?: string;
  userId?: string;
}

interface Conversation {
  id: string;
  title: string;
  messages: Message[];
  project?: string;
  tags?: string[];
  userId: string;
  createdAt: string;
  updatedAt: string;
}

export default function Home() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [loading, setLoading] = useState(false);
  const [currentUser, setCurrentUser] = useState<'zach' | 'rebecca'>('zach');
  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [currentConversationId, setCurrentConversationId] = useState<string>('');
  const [currentProject, setCurrentProject] = useState('');
  const [currentTags, setCurrentTags] = useState('');
  const [showFileUpload, setShowFileUpload] = useState(false);
  const [expandedProjects, setExpandedProjects] = useState<Set<string>>(new Set(['All']));
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const [isInitialized, setIsInitialized] = useState(false);

  // Functions
  const loadConversationsFromStorage = () => {
    const saved = localStorage.getItem('kimbleai_conversations');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        setConversations(parsed);
      } catch (e) {
        console.error('Failed to parse saved conversations:', e);
      }
    }
  };

  const saveConversationsToStorage = (convs: Conversation[]) => {
    localStorage.setItem('kimbleai_conversations', JSON.stringify(convs));
  };

  const loadConversation = useCallback((convId: string) => {
    const conv = conversations.find(c => c.id === convId);
    if (conv) {
      setMessages(conv.messages || []);
      setCurrentConversationId(convId);
      setCurrentProject(conv.project || '');
      setCurrentTags(conv.tags?.join(', ') || '');
      localStorage.setItem('kimbleai_current_conversation', convId);
    }
  }, [conversations]);

  const startNewConversation = () => {
    const newId = 'conv_' + Date.now();
    setCurrentConversationId(newId);
    setMessages([]);
    setCurrentProject('');
    setCurrentTags('');
    localStorage.setItem('kimbleai_current_conversation', newId);
  };

  // Group conversations by project
  const getProjectGroups = () => {
    const groups: { [key: string]: Conversation[] } = { 'All': [] };

    conversations
      .filter(c => c.userId === currentUser)
      .forEach(conv => {
        const projectName = conv.project || 'Uncategorized';
        if (!groups[projectName]) {
          groups[projectName] = [];
        }
        groups[projectName].push(conv);
        groups['All'].push(conv);
      });

    return groups;
  };

  // Load conversations on mount
  useEffect(() => {
    if (!isInitialized) {
      loadConversationsFromStorage();
      const savedConvId = localStorage.getItem('kimbleai_current_conversation');
      const savedUser = localStorage.getItem('kimbleai_current_user') as 'zach' | 'rebecca';

      if (savedUser) setCurrentUser(savedUser);

      if (savedConvId) {
        setCurrentConversationId(savedConvId);
        loadConversation(savedConvId);
      } else {
        startNewConversation();
      }
      setIsInitialized(true);
    }
  }, [isInitialized, loadConversation]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  useEffect(() => {
    localStorage.setItem('kimbleai_current_user', currentUser);
  }, [currentUser]);


  const saveCurrentConversation = () => {
    if (!currentConversationId || messages.length === 0) return;

    const conversation: Conversation = {
      id: currentConversationId,
      title: messages[0]?.content.substring(0, 50) || 'New Chat',
      messages: messages,
      project: currentProject,
      tags: currentTags.split(',').map(t => t.trim()).filter(t => t),
      userId: currentUser,
      createdAt: conversations.find(c => c.id === currentConversationId)?.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    const existingIndex = conversations.findIndex(c => c.id === currentConversationId);
    let updated: Conversation[];

    if (existingIndex >= 0) {
      updated = [...conversations];
      updated[existingIndex] = conversation;
    } else {
      updated = [conversation, ...conversations];
    }

    setConversations(updated);
    saveConversationsToStorage(updated);
  };

  const deleteConversation = (convId: string) => {
    const updated = conversations.filter(c => c.id !== convId);
    setConversations(updated);
    saveConversationsToStorage(updated);

    if (convId === currentConversationId) {
      startNewConversation();
    }
  };

  const sendMessage = async () => {
    if (!inputValue.trim() || loading) return;

    const userMessage: Message = {
      role: 'user',
      content: inputValue,
      timestamp: new Date().toISOString(),
      userId: currentUser
    };

    const newMessages = [...messages, userMessage];
    setMessages(newMessages);
    setInputValue('');
    setLoading(true);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: newMessages.map(m => ({ role: m.role, content: m.content })),
          userId: currentUser,
          conversationId: currentConversationId,
          projectId: currentProject,
          tags: currentTags.split(',').map(t => t.trim()).filter(t => t)
        }),
      });

      const data = await response.json();

      const assistantMessage: Message = {
        role: 'assistant',
        content: data.response || 'No response',
        timestamp: new Date().toISOString()
      };

      const updatedMessages = [...newMessages, assistantMessage];
      setMessages(updatedMessages);

      setTimeout(() => saveCurrentConversation(), 100);

    } catch (error: any) {
      console.error('Chat error:', error);
      const errorMessage: Message = {
        role: 'assistant',
        content: `Error: ${error.message}`,
        timestamp: new Date().toISOString()
      };
      setMessages([...newMessages, errorMessage]);
    } finally {
      setLoading(false);
    }
  };

  const toggleProject = (projectName: string) => {
    const newExpanded = new Set(expandedProjects);
    if (newExpanded.has(projectName)) {
      newExpanded.delete(projectName);
    } else {
      newExpanded.add(projectName);
    }
    setExpandedProjects(newExpanded);
  };

  const projectGroups = getProjectGroups();

  return (
    <div style={{
      display: 'flex',
      height: '100vh',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
      backgroundColor: '#0f0f0f',
      color: '#ffffff'
    }}>
      {/* SIDEBAR */}
      <div style={{
        width: '280px',
        backgroundColor: '#171717',
        borderRight: '1px solid #2a2a2a',
        display: 'flex',
        flexDirection: 'column',
        position: 'relative'
      }}>
        {/* Header */}
        <div style={{ padding: '16px', borderBottom: '1px solid #2a2a2a' }}>
          <button
            onClick={startNewConversation}
            style={{
              width: '100%',
              padding: '12px 16px',
              backgroundColor: 'transparent',
              border: '1px solid #404040',
              borderRadius: '8px',
              color: '#ffffff',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '500',
              marginBottom: '16px',
              transition: 'all 0.2s ease'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.backgroundColor = '#2a2a2a';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.backgroundColor = 'transparent';
            }}
          >
            + New Chat
          </button>

          {/* User Switch */}
          <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
            <button
              onClick={() => setCurrentUser('zach')}
              style={{
                flex: 1,
                padding: '8px 12px',
                borderRadius: '6px',
                border: '1px solid #404040',
                backgroundColor: currentUser === 'zach' ? '#0066cc' : 'transparent',
                color: '#ffffff',
                cursor: 'pointer',
                fontSize: '13px',
                fontWeight: '500'
              }}
            >
              Zach (Admin)
            </button>
            <button
              onClick={() => setCurrentUser('rebecca')}
              style={{
                flex: 1,
                padding: '8px 12px',
                borderRadius: '6px',
                border: '1px solid #404040',
                backgroundColor: currentUser === 'rebecca' ? '#cc0066' : 'transparent',
                color: '#ffffff',
                cursor: 'pointer',
                fontSize: '13px',
                fontWeight: '500'
              }}
            >
              Rebecca (User)
            </button>
          </div>
        </div>

        {/* Conversations List */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '8px 16px' }}>
          <div style={{ color: '#808080', fontSize: '12px', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
            Conversations
          </div>

          {Object.entries(projectGroups).map(([projectName, convs]) => (
            <div key={projectName} style={{ marginBottom: '8px' }}>
              <div
                onClick={() => toggleProject(projectName)}
                style={{
                  padding: '8px 12px',
                  backgroundColor: 'transparent',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '4px',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#2a2a2a';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ color: '#808080', fontSize: '12px' }}>
                    {expandedProjects.has(projectName) ? '▼' : '▶'}
                  </span>
                  <span style={{ color: '#ffffff', fontSize: '14px', fontWeight: '500' }}>
                    {projectName === 'All' ? 'All Conversations' :
                     projectName === 'Uncategorized' ? 'No Project' :
                     projectName}
                  </span>
                </div>
                <span style={{
                  backgroundColor: '#404040',
                  color: '#ffffff',
                  padding: '2px 8px',
                  borderRadius: '12px',
                  fontSize: '11px',
                  fontWeight: '500'
                }}>
                  {convs.length}
                </span>
              </div>

              {expandedProjects.has(projectName) && (
                <div style={{ marginLeft: '24px' }}>
                  {convs.slice(0, 15).map(conv => (
                    <div
                      key={conv.id}
                      onClick={() => loadConversation(conv.id)}
                      style={{
                        padding: '8px 12px',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        backgroundColor: conv.id === currentConversationId ? '#2a2a2a' : 'transparent',
                        marginBottom: '2px',
                        transition: 'all 0.2s ease'
                      }}
                      onMouseEnter={(e) => {
                        if (conv.id !== currentConversationId) {
                          e.currentTarget.style.backgroundColor = '#1f1f1f';
                        }
                      }}
                      onMouseLeave={(e) => {
                        if (conv.id !== currentConversationId) {
                          e.currentTarget.style.backgroundColor = 'transparent';
                        }
                      }}
                    >
                      <div style={{ color: '#ffffff', fontSize: '13px', marginBottom: '4px', lineHeight: '1.4' }}>
                        {conv.title}
                      </div>
                      {conv.tags && conv.tags.length > 0 && (
                        <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                          {conv.tags.slice(0, 3).map((tag, i) => (
                            <span key={i} style={{
                              fontSize: '10px',
                              backgroundColor: '#404040',
                              color: '#cccccc',
                              padding: '2px 6px',
                              borderRadius: '4px'
                            }}>
                              {tag}
                            </span>
                          ))}
                          {conv.tags.length > 3 && (
                            <span style={{
                              fontSize: '10px',
                              color: '#808080'
                            }}>
                              +{conv.tags.length - 3}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                  {convs.length > 15 && (
                    <div style={{ padding: '8px 12px', color: '#808080', fontSize: '11px' }}>
                      +{convs.length - 15} more conversations
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>

        {/* Bottom Section */}
        <div style={{ borderTop: '1px solid #2a2a2a' }}>
          {/* File Upload */}
          <div style={{ padding: '12px 16px' }}>
            <button
              onClick={() => setShowFileUpload(!showFileUpload)}
              style={{
                width: '100%',
                padding: '10px 12px',
                backgroundColor: 'transparent',
                border: '1px solid #404040',
                borderRadius: '6px',
                color: '#ffffff',
                cursor: 'pointer',
                fontSize: '13px',
                fontWeight: '500'
              }}
            >
              Upload Files
            </button>

            {showFileUpload && (
              <div style={{ marginTop: '12px' }}>
                <FileUpload userId={currentUser} onUploadComplete={() => {
                  console.log('Uploaded');
                  setShowFileUpload(false);
                }} />
              </div>
            )}
          </div>

          {/* Google Auth */}
          <div style={{ padding: '12px 16px', borderTop: '1px solid #2a2a2a' }}>
            <GoogleAuth userId={currentUser} />
          </div>
        </div>
      </div>

      {/* MAIN AREA */}
      <div style={{ flex: 1, display: 'flex', flexDirection: 'column', backgroundColor: '#0f0f0f' }}>
        {/* Header */}
        <div style={{ padding: '16px 24px', borderBottom: '1px solid #2a2a2a' }}>
          <h1 style={{
            color: '#ffffff',
            fontSize: '18px',
            marginBottom: '16px',
            fontWeight: '600'
          }}>
            KimbleAI • {currentUser === 'zach' ? 'Zach (Admin)' : 'Rebecca (User)'}
          </h1>

          <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
            <input
              type="text"
              value={currentProject}
              onChange={(e) => setCurrentProject(e.target.value)}
              onBlur={saveCurrentConversation}
              placeholder="Project name"
              style={{
                padding: '8px 12px',
                backgroundColor: '#171717',
                border: '1px solid #404040',
                borderRadius: '6px',
                color: '#ffffff',
                fontSize: '13px',
                minWidth: '150px'
              }}
            />
            <input
              type="text"
              value={currentTags}
              onChange={(e) => setCurrentTags(e.target.value)}
              onBlur={saveCurrentConversation}
              placeholder="Tags (comma separated)"
              style={{
                padding: '8px 12px',
                backgroundColor: '#171717',
                border: '1px solid #404040',
                borderRadius: '6px',
                color: '#ffffff',
                fontSize: '13px',
                minWidth: '200px'
              }}
            />
          </div>
        </div>

        {/* Messages */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '24px' }}>
          {messages.length === 0 && (
            <div style={{
              textAlign: 'center',
              color: '#808080',
              marginTop: '100px',
              fontSize: '16px'
            }}>
              <div style={{ marginBottom: '8px' }}>Welcome to KimbleAI</div>
              <div style={{ fontSize: '14px' }}>Start a conversation to experience automatic context retrieval</div>
            </div>
          )}

          {messages.map((message, index) => (
            <div key={index} style={{
              marginBottom: '24px',
              display: 'flex',
              gap: '16px'
            }}>
              <div style={{
                width: '32px',
                height: '32px',
                borderRadius: '6px',
                backgroundColor: message.role === 'user'
                  ? (currentUser === 'rebecca' ? '#cc0066' : '#0066cc')
                  : '#16a085',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                color: 'white',
                fontSize: '14px',
                fontWeight: '600',
                flexShrink: 0
              }}>
                {message.role === 'user' ? (currentUser === 'rebecca' ? 'R' : 'Z') : 'AI'}
              </div>
              <div style={{
                flex: 1,
                color: '#ffffff',
                fontSize: '14px',
                lineHeight: '1.6',
                paddingTop: '6px'
              }}>
                <div style={{ whiteSpace: 'pre-wrap' }}>
                  {message.content}
                </div>
              </div>
            </div>
          ))}

          {loading && (
            <div style={{
              marginBottom: '24px',
              display: 'flex',
              gap: '16px'
            }}>
              <div style={{
                width: '32px',
                height: '32px',
                borderRadius: '6px',
                backgroundColor: '#16a085',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                color: 'white',
                fontSize: '14px',
                fontWeight: '600'
              }}>
                AI
              </div>
              <div style={{
                flex: 1,
                color: '#808080',
                fontSize: '14px',
                paddingTop: '6px'
              }}>
                Thinking...
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Input */}
        <div style={{ padding: '24px', borderTop: '1px solid #2a2a2a' }}>
          <div style={{
            display: 'flex',
            gap: '12px',
            maxWidth: '900px',
            margin: '0 auto',
            alignItems: 'flex-end'
          }}>
            <div style={{ flex: 1, position: 'relative' }}>
              <textarea
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                  }
                }}
                placeholder="Type your message..."
                disabled={loading}
                style={{
                  width: '100%',
                  minHeight: '44px',
                  maxHeight: '200px',
                  padding: '12px 16px',
                  backgroundColor: '#171717',
                  border: '1px solid #404040',
                  borderRadius: '12px',
                  color: '#ffffff',
                  fontSize: '14px',
                  resize: 'none',
                  outline: 'none',
                  fontFamily: 'inherit'
                }}
                rows={1}
                onInput={(e) => {
                  const target = e.target as HTMLTextAreaElement;
                  target.style.height = 'auto';
                  target.style.height = Math.min(target.scrollHeight, 200) + 'px';
                }}
              />
            </div>
            <button
              onClick={sendMessage}
              disabled={loading || !inputValue.trim()}
              style={{
                padding: '12px 20px',
                backgroundColor: loading || !inputValue.trim() ? '#404040' : '#16a085',
                border: 'none',
                borderRadius: '12px',
                color: 'white',
                cursor: loading || !inputValue.trim() ? 'not-allowed' : 'pointer',
                fontSize: '14px',
                fontWeight: '500',
                height: '44px'
              }}
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}